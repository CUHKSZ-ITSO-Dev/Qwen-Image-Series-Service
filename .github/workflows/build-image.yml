name: æ„å»ºDockeré•œåƒ

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: cuhksz-itso-dev/qwen-image-series-svc

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ç”Ÿæˆæ—¶é—´æˆ³æ ‡ç­¾
      id: timestamp
      run: |
        TIMESTAMP=$(TZ=Asia/Shanghai date +%Y%m%d-%H%M)
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "ç”Ÿæˆçš„æ—¶é—´æˆ³æ ‡ç­¾: $TIMESTAMP"

    - name: ç™»å½•åˆ°GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64

    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=${{ steps.timestamp.outputs.timestamp }}
          type=raw,value=latest
        labels: |
          org.opencontainers.image.title=${{ env.IMAGE_NAME }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}

    - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

    - name: è¾“å‡ºé•œåƒä¿¡æ¯
      if: github.event_name != 'pull_request'
      run: |
        echo "ğŸ‰ Dockeré•œåƒæ„å»ºæˆåŠŸ!"
        echo "ğŸ“¦ é•œåƒåç§°: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
        echo "ğŸ·ï¸  æ ‡ç­¾: ${{ steps.timestamp.outputs.timestamp }}, latest"
        echo "ğŸ”— é•œåƒæ‹‰å–å‘½ä»¤:"
        echo "   docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.timestamp.outputs.timestamp }}"
        echo "   docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "â„¹ï¸  æ³¨æ„ï¼šé¦–æ¬¡æ‹‰å–å¯èƒ½éœ€è¦å…ˆç™»å½•åˆ°GitHub Container Registry"
        echo "   echo \$GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin"
